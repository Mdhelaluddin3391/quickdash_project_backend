{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}"> <link rel="stylesheet" href="{% static 'css/product_detail_style.css' %}">
    
    <title>QuickDash - Loading...</title>

    <style>
        /* Loading indicator ke liye */
        .loader {
            text-align: center;
            padding: 50px;
            font-size: 1.5rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="javascript:history.back()" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="header-title" id="product-name-title">Product Details</h1>
        <div class="header-placeholder"></div>
    </header>

    <div id="main-content-container">
        <div class="loader" id="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
    </div>

    <div class="fixed-cart-bar" id="cart-bar" style="display: none;">
        <div class="price-details">
            <span class="current-price" id="bar-price">₹0</span>
            <span class="original-price" id="bar-original-price"></span>
        </div>
        <button class="add-to-cart-btn" id="add-to-cart-button">
            <i class="fas fa-plus"></i> Add to Cart
        </button>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const mainContainer = document.getElementById('main-content-container');
            const loader = document.getElementById('loading-indicator');
            const titleElement = document.getElementById('product-name-title');
            
            // Cart Bar elements
            const cartBar = document.getElementById('cart-bar');
            const barPrice = document.getElementById('bar-price');
            const barOriginalPrice = document.getElementById('bar-original-price');
            const addToCartButton = document.getElementById('add-to-cart-button');

            let variantId; // Variant ID ko store karne ke liye
            let productId; // Base Product ID ko store karne ke liye

            // 1. URL se Product (Variant) ID nikalna
            try {
                const pathParts = window.location.pathname.split('/');
                variantId = pathParts[2]; // [0]="", [1]="product", [2]="<id>"
                if (!variantId || isNaN(variantId)) {
                    throw new Error("Invalid ID");
                }
            } catch (e) {
                console.error("ID nahi mil saki:", e);
                mainContainer.innerHTML = "<p class='loader'>Error: Invalid Product URL.</p>";
                return;
            }

            // 2. Product data fetch karne ka function
            async function fetchProductDetails(id) {
                try {
                    // Kadam A: Product (Variant) ki details fetch karein
                    const inventoryResponse = await fetch(`/api/inventory/products/${id}/`);
                    if (!inventoryResponse.ok) {
                        throw new Error(`Product not found (ID: ${id})`);
                    }
                    const data = await inventoryResponse.json();
                    
                    // Product ID (reviews ke liye)
                    productId = data.product.id; 

                    // Kadam B: Product reviews fetch karein
                    let reviews = [];
                    try {
                        const reviewsResponse = await fetch(`/api/store/products/${productId}/reviews/`);
                        if (reviewsResponse.ok) {
                            reviews = await reviewsResponse.json();
                        }
                    } catch (e) {
                        console.warn("Reviews fetch karne mein error:", e);
                    }

                    // Kadam C: Sab render karein
                    renderProduct(data, reviews);

                } catch (error) {
                    console.error("Product fetch karne mein error:", error);
                    mainContainer.innerHTML = `<p class='loader'>${error.message}. Please go back.</p>`;
                }
            }

            // 3. Product data ko HTML mein render karne ka function
            function renderProduct(data, reviews) {
                // Static (hardcoded) HTML ko replace karein
                
                const product = data.product;
                const price = data.price.price;
                const originalPrice = data.price.original_price;
                const discount = (originalPrice && parseFloat(price) < parseFloat(originalPrice));
                const isOutOfStock = data.is_out_of_stock;

                // Page title update karein
                titleElement.innerText = product.name;
                document.title = `QuickDash - ${product.name}`;
                
                // Discount Badge HTML
                const discountBadgeHtml = discount 
                    ? `<div class="discount-badge-large">${Math.round(((originalPrice - price) / originalPrice) * 100)}% OFF</div>` 
                    : '';

                // Price HTML (Product Info Section)
                let priceHtml = `<div class="price-large">₹${price}</div>`;
                if (discount) {
                    priceHtml = `
                        <div class="price-large">₹${price}
                            <span class="original-price-large">₹${originalPrice}</span>
                        </div>
                    `;
                }

                // Variants HTML (Abhi ke liye static, baad mein is
                // 'data.available_variants' se dynamic bana sakte hain)
                // Hum assume kar rahe hain ki 'data.variant_name' maujood hai
                const variantHtml = `
                    <div class="variant-selector">
                        <button class="variant-option active">${data.variant_name || 'Standard'}</button>
                    </div>
                `;
                
                // Reviews HTML
                let reviewsHtml = '';
                if (reviews && reviews.length > 0) {
                    reviewsHtml = `
                        <div class="product-section">
                            <h3 class="section-title">Reviews (${reviews.length})</h3>
                            ${reviews.map(review => `
                                <div class="review-card">
                                    <div class="review-header">
                                        <span class="review-author">${review.user.first_name || 'User'}</span>
                                        <div class="review-rating">
                                            ${'<i class="fas fa-star"></i>'.repeat(review.rating)}
                                            ${'<i class="far fa-star"></i>'.repeat(5 - review.rating)}
                                        </div>
                                    </div>
                                    <p class="review-comment">${review.comment}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    reviewsHtml = `
                        <div class="product-section">
                            <h3 class="section-title">Reviews</h3>
                            <p>No reviews yet for this product.</p>
                        </div>
                    `;
                }

                // Poora main content HTML
                const mainHtml = `
                    <main>
                        <section class="product-image-section">
                            <img src="${product.main_image}" alt="${product.name}">
                            ${discountBadgeHtml}
                        </section>

                        <section class="product-info-section">
                            <h1 class="product-title-large">${product.name}</h1>
                            <p class="product-brand">${product.brand || 'QuickDash'}</p>
                            
                            ${priceHtml}

                            <div class="product-section">
                                <h3 class="section-title">Variant</h3>
                                ${variantHtml}
                            </div>
                            
                            <div class="product-section">
                                <h3 class="section-title">Description</h3>
                                <p class="product-description">
                                    ${product.description || 'No description available.'}
                                </p>
                            </div>

                            ${reviewsHtml}
                            
                        </section>
                    </main>
                `;

                // Loader ko hata kar main content daalein
                mainContainer.innerHTML = mainHtml;

                // Cart Bar ko update aur display karein
                barPrice.innerText = `₹${price}`;
                if (discount) {
                    barOriginalPrice.innerText = `₹${originalPrice}`;
                    barOriginalPrice.style.display = 'inline';
                } else {
                    barOriginalPrice.style.display = 'none';
                }
                
                if (isOutOfStock) {
                    addToCartButton.innerText = 'Out of Stock';
                    addToCartButton.disabled = true;
                } else {
                    addToCartButton.innerText = 'Add to Cart';
                    addToCartButton.disabled = false;
                }

                cartBar.style.display = 'flex';
            }
            
            // 4. "Add to Cart" button par click listener
            addToCartButton.addEventListener('click', () => {
                // 'variantId' wahi hai jo humne URL se nikala tha
                console.log(`Adding variant ${variantId} to cart...`);

                // Yahan Cart API call (fetch POST request) aani chahiye
                // e.g., fetch('/api/cart/add/', { method: 'POST', ... })

                // Button ka state badalna
                addToCartButton.innerText = 'Added!';
                addToCartButton.style.backgroundColor = 'var(--success)';
                addToCartButton.disabled = true;
                
                setTimeout(() => {
                    addToCartButton.innerText = 'Add to Cart';
                    addToCartButton.style.backgroundColor = 'var(--primary)';
                    addToCartButton.disabled = false;
                }, 1500); // 1.5 second baad reset
            });

            // 5. Page load par main function ko call karein
            fetchProductDetails(variantId);
        });
    </script>

</body>
</html>