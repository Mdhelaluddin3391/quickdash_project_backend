{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/support_style.css' %}">
    
    <title>QuickDash - Help & Support</title>

    <style>
        /* Loading/Error/Success indicator ke liye */
        .status-message {
            text-align: center;
            padding: 20px;
            font-size: 1.1rem;
            color: var(--text-muted);
        }
        .success-message {
            color: var(--success);
            text-align: center;
            font-weight: 500;
        }
        .error-message {
            color: #ff4d4d;
            text-align: center;
            font-weight: 500;
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="{% url 'web:profile' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="header-title">Help & Support</h1>
        <div class="header-placeholder"></div>
    </header>

    <main id="main-content-container">

        <section class="support-section">
            <h2 class="section-title">Submit a Request</h2>
            <form id="support-form">
                <div class="form-group">
                    <label for="subject">Subject</label>
                    <input type="text" id="subject" name="subject" placeholder="e.g., Issue with Order #123" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="5" placeholder="Please describe your issue in detail..." required></textarea>
                </div>
                <div class="status-message success-message" id="success-message" style="display: none;"></div>
                <div class="status-message error-message" id="error-message" style="display: none;"></div>
                
                <button type="submit" class="submit-ticket-btn" id="submit-btn">Submit Ticket</button>
            </form>
        </section>

        <section class="support-section">
            <h2 class="section-title">Your Tickets</h2>
            <div id="ticket-list-container">
                <div class="status-message" id="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i> Loading your tickets...
                </div>
                </div>
        </section>

    </main>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. Zaroori Elements ---
            const mainContainer = document.getElementById('main-content-container');
            const loader = document.getElementById('loading-indicator');
            const ticketListContainer = document.getElementById('ticket-list-container');
            
            // Form elements
            const supportForm = document.getElementById('support-form');
            const submitBtn = document.getElementById('submit-btn');
            const successMessage = document.getElementById('success-message');
            const errorMessage = document.getElementById('error-message');

            let accessToken = '';

            // --- 2. Authentication Check ---
            function checkAuth() {
                accessToken = localStorage.getItem('accessToken');
                if (!accessToken) {
                    // Agar login nahi hai, toh auth page par bhejo
                    window.location.href = "{% url 'web:auth' %}?next={% url 'web:support' %}";
                    return false;
                }
                return true;
            }

            // --- 3. Main Function: Tickets Fetch Karna ---
            async function fetchTickets() {
                loader.style.display = 'block'; // Loader dikhayein
                
                try {
                    const response = await fetch('/api/support/tickets/', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401) { // Token invalid
                            handleLogout();
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const tickets = await response.json();
                    
                    // Data milne ke baad, render karein
                    renderTickets(tickets);

                } catch (error) {
                    console.error("Tickets fetch karne mein error:", error);
                    loader.innerText = 'Could not load tickets.';
                }
            }

            // --- 4. Render Function: Tickets ko HTML mein badalna ---
            function renderTickets(tickets) {
                loader.style.display = 'none'; // Loader chupayein
                ticketListContainer.innerHTML = ''; // Saaf karein

                if (!tickets || tickets.length === 0) {
                    ticketListContainer.innerHTML = '<p class="status-message">You have no support tickets.</p>';
                    return;
                }

                tickets.forEach(ticket => {
                    const ticketHtml = `
                        <a href="/support/chat/${ticket.id}/" class="ticket-card">
                            <div class="ticket-details">
                                <h3 class="ticket-subject">${ticket.subject}</h3>
                                <p class="ticket-id">Ticket #${ticket.id}</p>
                            </div>
                            <div class="ticket-status ${ticket.status.toLowerCase()}">
                                <span>${ticket.status}</span>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </a>
                    `;
                    // Naye ticket ko list mein sabse upar add karein
                    ticketListContainer.insertAdjacentHTML('afterbegin', ticketHtml);
                });
            }

            // --- 5. Form Submission: Naya Ticket Banana ---
            async function handleTicketSubmit(e) {
                e.preventDefault();
                successMessage.style.display = 'none';
                errorMessage.style.display = 'none';
                submitBtn.disabled = true;
                submitBtn.innerText = 'Submitting...';

                const formData = new FormData(supportForm);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/api/support/tickets/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();

                    if (!response.ok) {
                        errorMessage.innerText = result.detail || 'Failed to submit ticket.';
                        errorMessage.style.display = 'block';
                    } else {
                        // SUCCESS!
                        successMessage.innerText = 'Ticket submitted successfully!';
                        successMessage.style.display = 'block';
                        supportForm.reset(); // Form ko reset karein
                        
                        // Naye ticket ko list mein add karein (bina poora refresh kiye)
                        const newTicketHtml = `
                            <a href="/support/chat/${result.id}/" class="ticket-card">
                                <div class="ticket-details">
                                    <h3 class="ticket-subject">${result.subject}</h3>
                                    <p class="ticket-id">Ticket #${result.id}</p>
                                </div>
                                <div class="ticket-status ${result.status.toLowerCase()}">
                                    <span>${result.status}</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </a>
                        `;
                        // "No tickets" message ko hatayein agar woh maujood hai
                        const noTicketsMsg = ticketListContainer.querySelector('.status-message');
                        if (noTicketsMsg) {
                            noTicketsMsg.remove();
                        }
                        ticketListContainer.insertAdjacentHTML('afterbegin', newTicketHtml);
                    }

                } catch (error) {
                    console.error('Ticket submit karne mein error:', error);
                    errorMessage.innerText = 'An error occurred. Please try again.';
                    errorMessage.style.display = 'block';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'Submit Ticket';
                }
            }

            // Helper function (agar token invalid ho)
            function handleLogout() {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                checkAuth(); // Redirect karega
            }

            // --- 6. Event Listeners ---
            supportForm.addEventListener('submit', handleTicketSubmit);

            // --- 7. Page Load Par Shuru Karein ---
            if (checkAuth()) {
                fetchTickets();
            }

        });
    </script>

</body>
</html>