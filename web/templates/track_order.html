{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/track_order_style.css' %}">
    
    <title>QuickDash - Track Order</title>
    <style>
        .error-message {
            color: #ff4d4d;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="{% url 'web:profile' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="header-title">Track Your Order</h1>
        <div class="header-placeholder"></div>
    </header>

    <main class="track-order-main">
        
        <form class="track-order-form" id="track-form">
            <label for="order-id-input">Enter Your Order ID</label>
            <input type="text" id="order-id-input" placeholder="e.g., 123">
            <button type="submit" id="track-btn">Track Order</button>
            <div class="error-message" id="error-message"></div>
        </form>

        <div class="tracking-results-container" id="tracking-results" style="display: none;">
            <h3 id="result-order-id"></h3>
            <div class="timeline" id="timeline-container">
                </div>
        </div>

    </main>

    <script>
        // NAYA: Poora JavaScript is page ko dynamic banane ke liye
        document.addEventListener('DOMContentLoaded', () => {

            const trackForm = document.getElementById('track-form');
            const orderIdInput = document.getElementById('order-id-input');
            const trackBtn = document.getElementById('track-btn');
            const errorMessage = document.getElementById('error-message');
            
            const resultsContainer = document.getElementById('tracking-results');
            const resultOrderId = document.getElementById('result-order-id');
            const timelineContainer = document.getElementById('timeline-container');
            
            let accessToken = '';
            
            // --- Helper Functions (Auth, Refresh) ---
            function getAuthToken() {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    window.location.href = `{% url 'web:auth' %}?next={% url 'web:track-order' %}`;
                    return null;
                }
                return token;
            }

            async function refreshToken() {
                const refresh = localStorage.getItem('refreshToken');
                if (!refresh) return false;
                try {
                    const response = await fetch('/api/token/refresh/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refresh: refresh })
                    });
                    if (!response.ok) return false;
                    const data = await response.json();
                    localStorage.setItem('accessToken', data.access);
                    accessToken = data.access;
                    return true;
                } catch (e) {
                    return false;
                }
            }

            async function fetchAuthenticated(url, options = {}, isRetry = false) {
                options.headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`,
                    ...options.headers
                };
                const response = await fetch(url, options);
                if (response.status === 401 && !isRetry) {
                    const refreshed = await refreshToken();
                    if (refreshed) return fetchAuthenticated(url, options, true);
                    else {
                        getAuthToken();
                        return null;
                    }
                }
                return response;
            }

            // --- Form Submit Logic ---
            trackForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorMessage.innerText = '';
                resultsContainer.style.display = 'none';
                
                const orderId = orderIdInput.value;
                if (!orderId) {
                    errorMessage.innerText = 'Please enter an Order ID.';
                    return;
                }
                
                trackBtn.disabled = true;
                trackBtn.innerText = 'Tracking...';

                try {
                    // Hum assume kar rahe hain ki order-detail endpoint hi tracking info deta hai
                    const response = await fetchAuthenticated(`/api/orders/${orderId}/`);
                    
                    if (!response) return; // Auth fail
                    if (!response.ok) {
                        throw new Error('Order not found or you do not have permission.');
                    }
                    
                    const orderData = await response.json();
                    renderTracking(orderData);

                } catch (error) {
                    errorMessage.innerText = error.message;
                } finally {
                    trackBtn.disabled = false;
                    trackBtn.innerText = 'Track Order';
                }
            });

            // --- Render Tracking Timeline ---
            function renderTracking(order) {
                resultOrderId.innerText = `Tracking Order #${order.id}`;
                timelineContainer.innerHTML = '';
                
                const statuses = [
                    { name: 'PENDING', icon: 'fa-clock', text: 'Order Placed' },
                    { name: 'CONFIRMED', icon: 'fa-check-circle', text: 'Order Confirmed' },
                    { name: 'PREPARING', icon: 'fa-box', text: 'Preparing Order' },
                    { name: 'OUT_FOR_DELIVERY', icon: 'fa-truck', text: 'Out for Delivery' },
                    { name: 'DELIVERED', icon: 'fa-home', text: 'Delivered' },
                ];
                
                const cancelled = { name: 'CANCELLED', icon: 'fa-times-circle', text: 'Order Cancelled' };

                if (order.status === 'CANCELLED') {
                    timelineContainer.innerHTML = createTimelineNode(cancelled, true);
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                let currentStatusFound = false;
                statuses.reverse().forEach(status => {
                    let isActive = false;
                    
                    if (!currentStatusFound) {
                        if (status.name === order.status) {
                            currentStatusFound = true;
                            isActive = true;
                        } else {
                            // Agar status match nahi hua, toh check karein ki kya
                            // order.status list mein pehle aata hai
                            const orderStatusIndex = statuses.findIndex(s => s.name === order.status);
                            const currentStatusIndex = statuses.findIndex(s => s.name === status.name);
                            if (orderStatusIndex >= currentStatusIndex) {
                                isActive = true;
                                currentStatusFound = (orderStatusIndex === currentStatusIndex);
                            }
                        }
                    }

                    timelineContainer.innerHTML += createTimelineNode(status, isActive);
                });
                
                // Timeline ko seedha karne ke liye
                timelineContainer.innerHTML = Array.from(timelineContainer.childNodes).reverse().map(node => node.outerHTML).join('');

                resultsContainer.style.display = 'block';
            }

            function createTimelineNode(status, isActive) {
                return `
                    <div class="timeline-item ${isActive ? 'active' : ''}">
                        <div class="timeline-icon">
                            <i class="fas ${status.icon}"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>${status.text}</h4>
                        </div>
                    </div>
                `;
            }

            // --- Page Load Par Auth Check ---
            accessToken = getAuthToken();
        });
    </script>

</body>
</html>