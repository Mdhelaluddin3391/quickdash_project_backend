{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}">
    <title>QuickDash - Home</title>

</head>

<body>

    <header class="new-header">
        <div class="header-top-row">
            <div class="logo-location-group">
                <a href="{% url 'web:index' %}" class="logo"> <i class="fas fa-bolt"></i>
                    <span>QuickDash</span>
                </a>
                <div class="location">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="location-display">Detecting location...</span>
                </div>
            </div>

            <div class="header-icons">
                <a href="{% url 'web:profile' %}" class="icon-link"> <i class="far fa-user"></i>
                    <span class="icon-text">Account</span>
                </a>
                <a href="{% url 'web:cart' %}" class="icon-link cart-link"> <i class="fas fa-shopping-cart"></i>
                    <span class="icon-text">Cart</span>
                    <span class="cart-count" id="cart-count">0</span>
                </a>
            </div>
        </div>

        <form class="search-bar-row" method="GET" action="{% url 'web:search' %}"> <i class="fas fa-search"></i>
            <input type="text" name="q" placeholder="Search for items..." value="">
        </form>

        <nav class="header-nav-row" id="header-nav-categories">
            <a href="{% url 'web:index' %}" class="nav-item active">All</a>
            </nav>
    </header>

    <section class="hero-section">
        <div class="scroll-banner" id="banner-container">
            <p class="status-message"><i class="fas fa-spinner fa-spin"></i></p>
        </div>
    </section>

    <main>
        <section>
            <div class="section-title">
                <h2>Shop By Category</h2>
                <a href="{% url 'web:category' %}" class="view-all">View All</a>
            </div>
            <div class="categories" id="category-container">
                <p class="status-message"><i class="fas fa-spinner fa-spin"></i></p>
            </div>
        </section>

        <section>
            <div class="section-title">
                <h2>Featured Products</h2>
            </div>
            <div class="scroll-container">
                <div class="product-grid" id="featured-product-grid">
                    <p class="status-message"><i class="fas fa-spinner fa-spin"></i></p>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>QuickDash</h3>
                    <p>Groceries delivered in minutes.</p>
                </div>
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="{% url 'web:profile' %}">Account</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>© 2025 QuickDash. All Rights Reserved.</p>
            </div>
        </div>
    </footer>
    

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. Zaroori Elements ---
            const locationDisplay = document.getElementById('location-display');
            const bannerContainer = document.getElementById('banner-container');
            const categoryContainer = document.getElementById('category-container');
            const productContainer = document.getElementById('featured-product-grid');
            const navCategoryContainer = document.getElementById('header-nav-categories');
            const cartCountElement = document.getElementById('cart-count');
            
            let accessToken = localStorage.getItem('accessToken'); // Ho sakta hai null ho

            // --- 2. Helper Functions (Auth, CSRF) ---
            function getCsrfToken() {
                return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            }

            // NAYA: Token Refresh Logic (Optional but good)
            async function refreshToken() {
                const refresh = localStorage.getItem('refreshToken');
                if (!refresh) return false;
                try {
                    const response = await fetch('/api/token/refresh/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refresh: refresh })
                    });
                    if (!response.ok) return false;
                    const data = await response.json();
                    localStorage.setItem('accessToken', data.access);
                    accessToken = data.access;
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            // NAYA: API Fetch (Auth ke saath)
            async function fetchAuthenticated(url, options = {}, isRetry = false) {
                options.headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                // Sirf agar token hai tabhi Authorization header add karein
                if (accessToken) {
                    options.headers['Authorization'] = `Bearer ${accessToken}`;
                }

                const response = await fetch(url, options);

                if (response.status === 401 && !isRetry && accessToken) {
                    const refreshed = await refreshToken();
                    if (refreshed) return fetchAuthenticated(url, options, true); // Retry
                    else {
                        // Token refresh fail hua, tokens clear karein
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        accessToken = null;
                        return fetchAuthenticated(url, options, true); // Ab bina auth ke retry karein
                    }
                }
                return response;
            }

            // --- 3. Main Logic: Location paane ke baad hi sab fetch karein ---
            function startApp() {
                const lat = localStorage.getItem("userLatitude");
                const lon = localStorage.getItem("userLongitude");

                if (lat && lon) {
                    // Agar location pehle se hai
                    locationDisplay.innerText = "Near You"; // Simple text
                    fetchHomePageData(lat, lon);
                    fetchCartCount(); // Cart count bhi fetch karein
                } else {
                    // Agar location nahi hai, toh user se poochein
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            localStorage.setItem("userLatitude", latitude);
                            localStorage.setItem("userLongitude", longitude);
                            locationDisplay.innerText = "Near You";
                            fetchHomePageData(latitude, longitude);
                            fetchCartCount();
                        },
                        (error) => {
                            // Location DENIED
                            console.error("Geolocation error:", error);
                            window.location.href = "{% url 'web:location-denied' %}";
                        }
                    );
                }
            }

            // --- 4. API Call: Home Page Data ---
            async function fetchHomePageData(lat, lon) {
                try {
                    const response = await fetch(`/api/store/home-data/?lat=${lat}&lon=${lon}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    
                    // NAYA: Store ka naam dikhayein
                    if (data.store) {
                        locationDisplay.innerText = `Store: ${data.store.name}`;
                    }
                    
                    renderBanners(data.banners);
                    renderCategories(data.categories);
                    renderProducts(data.featured_products);

                } catch (error) {
                    console.error("Home page data fetch error:", error);
                    bannerContainer.innerHTML = "<p class='status-message'>Content load nahi ho saka.</p>";
                    categoryContainer.innerHTML = "<p class='status-message'>Categories load nahi ho saki.</p>";
                    productContainer.innerHTML = "<p class='status-message'>Products load nahi ho sake.</p>";
                }
            }
            
            // --- 5. API Call: Cart Count ---
            async function fetchCartCount() {
                if (!accessToken) {
                    cartCountElement.innerText = '0';
                    return;
                }
                try {
                    const response = await fetchAuthenticated('/api/cart/count/');
                    if (!response.ok) throw new Error('Could not fetch count');
                    const data = await response.json();
                    updateCartCount(data.item_count || 0);
                } catch (error) {
                    console.warn("Cart count error:", error.message);
                    cartCountElement.innerText = '0';
                }
            }
            
            function updateCartCount(count) {
                 cartCountElement.innerText = count;
                 if (count > 0) {
                     cartCountElement.style.display = 'flex';
                     // (Optional) Animation
                     cartCountElement.style.transform = 'scale(1.2)';
                     setTimeout(() => { cartCountElement.style.transform = 'scale(1)'; }, 200);
                 } else {
                     cartCountElement.style.display = 'none';
                 }
            }

            // --- 6. Render Functions ---
            function renderBanners(banners) {
                bannerContainer.innerHTML = '';
                if (!banners || banners.length === 0) {
                    bannerContainer.innerHTML = "<p class='status-message'>No promotions available.</p>";
                    return;
                }
                banners.forEach(banner => {
                    const bannerHtml = `
                        <a href="${banner.link || '#'}" class="promo-card">
                            <div class="promo-content">
                                <h3>${banner.title}</h3>
                            </div>
                            <img src="${banner.image}" alt="${banner.title}" class="promo-image-dynamic">
                        </a>
                    `;
                    bannerContainer.innerHTML += bannerHtml;
                });
            }

            function renderCategories(categories) {
                categoryContainer.innerHTML = '';
                navCategoryContainer.innerHTML = '<a href="{% url 'web:index' %}" class="nav-item active">All</a>'; // Reset

                if (!categories || categories.length === 0) {
                    categoryContainer.innerHTML = "<p class='status-message'>No categories found.</p>";
                    return;
                }
                
                categories.slice(0, 7).forEach(category => { // Home page par max 7 dikhayein
                    // NAYA: Image icon fix
                    const iconHtml = category.icon
                        ? `<img src="${category.icon}" alt="${category.name}" class="category-image">`
                        : `<i class="fas fa-tag"></i>`;

                    const categoryHtml = `
                        <a href="/category/${category.slug}/" class="category-card"> 
                            <div class="category-icon">
                                ${iconHtml}
                            </div>
                            <h3>${category.name}</h3>
                        </a>
                    `;
                    categoryContainer.innerHTML += categoryHtml;
                    
                    // Header nav bar mein bhi add karein
                    navCategoryContainer.innerHTML += `
                         <a href="/category/${category.slug}/" class="nav-item">${category.name}</a>
                    `;
                });
            }

            function renderProducts(products) {
                productContainer.innerHTML = '';
                if (!products || products.length === 0) {
                    productContainer.innerHTML = "<p class='status-message'>No featured products available.</p>";
                    return;
                }

                products.forEach(item => {
                    const product = item.product; 
                    const variantName = item.variant_name || '';
                    const price = item.price.price;
                    const originalPrice = item.price.original_price;
                    const discount = (originalPrice && parseFloat(price) < parseFloat(originalPrice));
                    const isOutOfStock = item.is_out_of_stock;
                    const mainImage = item.image || product.main_image; // NAYA: Variant image check

                    let priceHtml = `<div class="price">₹${price}</div>`;
                    if (discount) {
                        priceHtml = `<div class="price"><span class="original-price">₹${originalPrice}</span> ₹${price}</div>`;
                    }

                    let buttonHtml = `<button class="add-to-cart" data-variant-id="${item.id}"><i class="fas fa-plus"></i></button>`;
                    if (isOutOfStock) {
                        buttonHtml = `<span class="out-of-stock-btn">Out of Stock</span>`;
                    }

                    const productHtml = `
                        <div class="product-card">
                            <a href="/product/${product.id}/">
                                <div class="product-image">
                                    ${discount ? '<div class="discount-badge">OFF</div>' : ''}
                                    <img src="${mainImage}" alt="${product.name}">
                                </div>
                            </a>
                            <div class="product-info">
                                <h3 class="product-title">${product.name}</h3>
                                <div class="product-weight">${variantName}</div>
                                <div class="product-price">
                                    ${priceHtml}
                                    ${buttonHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    productContainer.innerHTML += productHtml;
                });

                attachCartButtonListeners();
            }
            
            // --- 7. Cart Button Logic (REAL) ---
            function attachCartButtonListeners() {
                document.querySelectorAll('.add-to-cart').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const variantId = e.currentTarget.dataset.variantId;
                        addToCart(variantId, button);
                    });
                });
            }

            async function addToCart(variantId, button, isRetry = false) {
                if (!accessToken) {
                    // Agar login nahi hai, toh login page par bhejo
                    window.location.href = `{% url 'web:auth' %}?next={% url 'web:index' %}`;
                    return;
                }
                
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    const response = await fetch('/api/cart/add/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({
                            inventory_id: variantId,
                            quantity: 1
                        })
                    });
                    
                    if (response.status === 401 && !isRetry) {
                        const refreshed = await refreshToken();
                        if (refreshed) addToCart(variantId, button, true);
                        else window.location.href = `{% url 'web:auth' %}?next={% url 'web:index' %}`;
                        return;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Could not add to cart');
                    }
                    
                    const data = await response.json();
                    
                    // Success!
                    button.innerHTML = '<i class="fas fa-check"></i>'; // Success icon
                    updateCartCount(data.total_items_in_cart); // Naye count se update karein
                    
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-plus"></i>'; // Wapas normal
                    }, 1000);

                } catch (error) {
                    console.error("Add to cart error:", error.message);
                    button.innerHTML = '<i class="fas fa-times"></i>'; // Error icon
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-plus"></i>';
                    }, 1000);
                }
            }

            // --- 8. App Shuru Karein ---
            startApp();
        });
    </script>

</body>
</html>