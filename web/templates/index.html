{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}">
    <title>QuickDash - Home</title>

    <style>
        /* YEH NAYA STYLE ADD KAREIN (Banner image ke liye) */
        .promo-image-dynamic {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-right: 10px;
        }
    </style>

</head>

<body>

    <header class="new-header">
        <div class="header-top-row">
            <div class="logo-location-group">
                <a href="{% url 'web:index' %}" class="logo"> <i class="fas fa-bolt"></i>
                    <span>QuickDash</span>
                </a>
                <div class="location">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Fastest Delivery • Dharmanagar</span>
                </div>
            </div>

            <div class="header-icons">
                <a href="{% url 'web:auth' %}" class="icon-link"> <i class="far fa-user"></i>
                    <span class="icon-text">Account</span>
                </a>
                <a href="{% url 'web:cart' %}" class="icon-link cart-link"> <i class="fas fa-shopping-cart"></i>
                    <span class="icon-text">Cart</span>
                    <span class="cart-count">0</span> 
                </a>
            </div>
        </div>

        <form class="search-bar-row" method="GET" action="{% url 'web:search' %}"> <i class="fas fa-search"></i>
            <input type="text" name="q" placeholder="Search for items..." value="">
        </form>

        <nav class="header-nav-row">
            <a href="index.html" class="nav-item active">All</a>
            <a href="category.html" class="nav-item">Groceries</a>
            <a href="category.html" class="nav-item">Vegetables</a>
            <a href="category.html" class="nav-item">Snacks</a>
            <a href="category.html" class="nav-item">Electronics</a>
            <a href="category.html" class="nav-item">Personal Care</a>
            <a href="category.html" class="nav-item">Dairy</a>
            <a href="category.html" class="nav-item">Meat</a>
        </nav>
    </header>

    <section class="hero-section">
        <div class="scroll-banner" id="banner-container">
            </div>
    </section>

    <main>

        <section>
            <div class="section-title">
                <h2>Shop By Category</h2>
                <a href="category.html" class="view-all">View All</a> </div>
            <div class="categories" id="category-container">
                </div>
        </section>

        <section>
            <div class="section-title">
                <h2>Featured Products</h2>
                <a href="#" class="view-all">More</a>
            </div>
            <div class="scroll-container">
                <div class="product-grid" id="featured-product-grid">
                    </div>
            </div>
        </section>

    </main>
    
    <section class="app-download-banner">
        </section>

    <section class="trust-badge-section">
        </section>

        <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>QuickDash</h3>
                    <p>Groceries delivered in minutes. Fresh products, best prices, and instant delivery.</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms & Conditions</a></li>
                        <li><a href="#">FAQ</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Categories</h3>
                    <ul class="footer-links">
                        <li><a href="#">Fruits & Vegetables</a></li>
                        <li><a href="#">Dairy & Breakfast</a></li>
                        <li><a href="#">Munchies</a></li>
                        <li><a href="#">Cold Drinks & Juices</a></li>
                        <li><a href="#">Instant & Frozen Food</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Download App</h3>
                    <div class="app-download">
                        <a href="#"><img
                        src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Google_Play_Store_badge_EN.svg/2560px-Google_Play_Store_badge_EN.svg.png"
                        alt="Get it on Google Play" style="height: 40px;"></a>
                    </div>
                     <div class="app-download">
                        <a href="#"><img
                        src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Download_on_the_App_Store_Badge.svg/2560px-Download_on_the_App_Store_Badge.svg.png"
                        alt="Download on the App Store" style="height: 40px;"></a>
                    </div>
                </div>
            </div>
            
            <div class="copyright">
                <p>© 2025 QuickDash. All Rights Reserved. Built for demo purposes.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // 1. Search Bar Logic (Aapka purana code, yeh theek hai)
            const input = document.querySelector('.search-bar-row input');
            const searchBar = document.querySelector('.search-bar-row');
            if (input && searchBar) {
                input.addEventListener('focus', () => {
                    searchBar.style.backgroundColor = '#fff';
                });
                input.addEventListener('blur', () => {
                    searchBar.style.backgroundColor = 'var(--light)';
                });
            }

            // 2. NAYA: Home Page ka data fetch karne ke liye function
            async function fetchHomePageData() {
                try {
                    // YEH HAI AAPKA API ENDPOINT
                    // Hum assume kar rahe hain ki 'store' app Django project mein '/api/store/' par registered hai
                    const response = await fetch('/api/store/home-data/');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Data milne ke baad, HTML render functions ko call karein
                    renderBanners(data.banners);
                    renderCategories(data.categories);
                    renderProducts(data.featured_products);

                } catch (error) {
                    console.error("Home page data fetch karne mein error:", error);
                    // User ko error dikhayein
                    document.getElementById('banner-container').innerHTML = "<p>Banners load nahi ho sake.</p>";
                    document.getElementById('category-container').innerHTML = "<p>Categories load nahi ho saki.</p>";
                    document.getElementById('featured-product-grid').innerHTML = "<p>Products load nahi ho sake.</p>";
                }
            }

            // 3. NAYA: Banners ko render karne ka function
            function renderBanners(banners) {
                const container = document.getElementById('banner-container');
                container.innerHTML = ''; // Container ko saaf karein
                
                if (!banners || banners.length === 0) {
                    container.innerHTML = "<p>No promotions available right now.</p>";
                    return;
                }

                banners.forEach(banner => {
                    // Data aapke BannerSerializer ke hisaab se (title, image, link)
                    // Humne icon ki jagah <img> ka istemal kiya hai
                    const bannerHtml = `
                        <a href="${banner.link || '#'}" class="promo-card">
                            <div class="promo-content">
                                <h3>${banner.title}</h3>
                            </div>
                            <img src="${banner.image}" alt="${banner.title}" class="promo-image-dynamic">
                        </a>
                    `;
                    container.innerHTML += bannerHtml;
                });
            }

            // 4. NAYA: Categories ko render karne ka function
            function renderCategories(categories) {
                const container = document.getElementById('category-container');
                container.innerHTML = ''; // Container ko saaf karein

                categories.forEach(category => {
                    // Data aapke CategorySerializer ke hisaab se (name, icon, slug)
                    // Humne link ko static 'category.html' se dynamic URL mein badal diya hai
                    const categoryHtml = `
                        <a href="/category/${category.slug}/" class="category-card"> 
                            <div class="category-icon">
                                <i class="${category.icon || 'fas fa-tag'}"></i> 
                            </div>
                            <h3>${category.name}</h3>
                        </a>
                    `;
                    container.innerHTML += categoryHtml;
                });
            }

            // 5. NAYA: Products ko render karne ka function
            function renderProducts(products) {
                const container = document.getElementById('featured-product-grid');
                container.innerHTML = ''; // Container ko saaf karein

                if (!products || products.length === 0) {
                    container.innerHTML = "<p>No featured products available.</p>";
                    return;
                }

                /* ZAROORI NOTE: Aapka HomePageDataSerializer 'featured_products' ke liye 
                'inventory.serializers.StoreInventoryListSerializer' ka istemal karta hai,
                jo file mujhe nahi di gayi hai.
                
                Main ASSUME kar raha hoon ki har product object (item) aisa dikhega:
                {
                   "id": (variant ka id),
                   "product": { "id": (product ka id), "name": "...", "main_image": "..." },
                   "variant_name": "500ml",
                   "price": { "price": "28.00", "original_price": "30.00" },
                   "is_out_of_stock": false
                }
                Agar yeh structure alag hai, toh niche diye gaye code ko badalna hoga.
                */

                products.forEach(item => {
                    // Upar diye gaye assumption ke aadhar par fields
                    const product = item.product; 
                    const variantName = item.variant_name || '';
                    const price = item.price.price;
                    const originalPrice = item.price.original_price;
                    const discount = (originalPrice && parseFloat(price) < parseFloat(originalPrice));
                    const isOutOfStock = item.is_out_of_stock;

                    let priceHtml = `<div class="price">₹${price}</div>`;
                    if (discount) {
                        priceHtml = `
                            <div class="price">
                                <span class="original-price">₹${originalPrice}</span> ₹${price}
                            </div>
                        `;
                    }

                    // Button logic
                    let buttonHtml = `<button class="add-to-cart" data-variant-id="${item.id}"><i class="fas fa-plus"></i></button>`;
                    if (isOutOfStock) {
                        buttonHtml = `<span class="out-of-stock-btn">Out of Stock</span>`;
                    }

                    // Product card HTML
                    const productHtml = `
                        <div class="product-card">
                            <a href="/product/${product.id}/">
                                <div class="product-image">
                                    ${discount ? '<div class="discount-badge">OFF</div>' : ''}
                                    <img src="${product.main_image}" alt="${product.name}">
                                </div>
                            </a>
                            <div class="product-info">
                                <h3 class="product-title">${product.name}</h3>
                                <div class="product-weight">${variantName}</div>
                                <div class="product-price">
                                    ${priceHtml}
                                    ${buttonHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += productHtml;
                });

                // Products render hone ke BAAD, naye bane 'add-to-cart' buttons par listener lagayein
                attachCartButtonListeners();
            }
            
            // 6. NAYA: Cart buttons par click logic (Aapka purana logic, naye function mein)
            function attachCartButtonListeners() {
                const allAddButtons = document.querySelectorAll('.add-to-cart');
                const cartCountElement = document.querySelector('.cart-count');

                allAddButtons.forEach(button => {
                    // Double listener lagane se bachne ke liye check
                    if (button.dataset.listenerAttached) return;

                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        
                        // Variant ID jise cart mein add karna hai
                        const variantId = event.currentTarget.dataset.variantId;
                        console.log(`Adding variant ${variantId} to cart...`);
                        
                        // !! ABHI KE LIYE: Hum sirf number badha rahe hain.
                        // Asli implementation mein, aapko yahan 'fetch' ka istemal karke
                        // cart API (e.g., /api/cart/add/) ko call karna chahiye.
                        
                        let currentCartCount = parseInt(cartCountElement.innerText);
                        currentCartCount++;
                        cartCountElement.innerText = currentCartCount;

                        // (Optional) Animation
                        cartCountElement.style.transform = 'scale(1.3)';
                        setTimeout(() => {
                            cartCountElement.style.transform = 'scale(1)';
                        }, 200);
                    });
                    
                    button.dataset.listenerAttached = 'true'; // Mark karein ki listener lag gaya hai
                });
            }

            // 7. NAYA: Page load par main function ko call karein
            fetchHomePageData();
            
            // Purana cart logic aur swipe logic hata diya gaya hai kyunki
            // - Cart logic ab dynamic hai (attachCartButtonListeners)
            // - Banner swipe logic ko abhi ke liye hata diya gaya hai (dynamic banners)

        });
    </script>

</body>
</html>