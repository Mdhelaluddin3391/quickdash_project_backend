{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/support_chat_style.css' %}">
    
    <title>QuickDash - Support Chat</title>

    <style>
        /* Loading/Error indicator ke liye */
        .status-message {
            text-align: center;
            padding: 40px;
            font-size: 1.1rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="{% url 'web:support' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="header-title" id="header-title">Ticket</h1>
        <div class="header-placeholder"></div>
    </header>

    <main class="chat-container" id="chat-container">
        
        <div class="status-message" id="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i> Loading messages...
        </div>

        </main>

    <form class="chat-input-form" id="message-form">
        <input type="text" id="message-input" name="message" placeholder="Type your message..." required>
        <button type="submit" class="send-btn" id="send-btn">
            <i class="fas fa-paper-plane"></i>
        </button>
    </form>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. Zaroori Elements ---
            const chatContainer = document.getElementById('chat-container');
            const loader = document.getElementById('loading-indicator');
            const headerTitle = document.getElementById('header-title');
            
            // Form elements
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');

            let accessToken = '';
            let ticketId = '';

            // --- 2. Authentication Check ---
            function checkAuth() {
                accessToken = localStorage.getItem('accessToken');
                if (!accessToken) {
                    window.location.href = "{% url 'web:auth' %}?next=" + window.location.pathname;
                    return false;
                }
                return true;
            }

            // --- 3. URL se Ticket ID nikalna ---
            function getTicketId() {
                try {
                    const pathParts = window.location.pathname.split('/');
                    const id = pathParts[3]; // [0]="", [1]="support", [2]="chat", [3]="<id>"
                    if (!id || isNaN(id)) {
                        throw new Error("Invalid ID");
                    }
                    return id;
                } catch (e) {
                    console.error("ID nahi mil saki:", e);
                    chatContainer.innerHTML = "<p class='status-message'>Error: Invalid Chat URL.</p>";
                    messageForm.style.display = 'none';
                    return null;
                }
            }

            // --- 4. Main Function: Messages Fetch Karna ---
            async function fetchMessages(id) {
                loader.style.display = 'block'; // Loader dikhayein
                
                try {
                    // API (support/urls.py se)
                    const response = await fetch(`/api/support/tickets/${id}/messages/`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401) { // Token invalid
                            handleLogout();
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const messages = await response.json();
                    
                    // Data milne ke baad, render karein
                    renderMessages(messages);

                } catch (error) {
                    console.error("Messages fetch karne mein error:", error);
                    loader.innerText = 'Could not load messages.';
                }
            }

            // --- 5. Render Function: Messages ko HTML mein badalna ---
            function renderMessages(messages) {
                loader.style.display = 'none'; // Loader chupayein
                chatContainer.innerHTML = ''; // Saaf karein

                if (!messages || messages.length === 0) {
                    chatContainer.innerHTML = '<p class="status-message">No messages yet. Send a message to start.</p>';
                    return;
                }

                // Title ko pehle message ke ticket subject se set kar sakte hain
                if (messages[0].ticket_subject) {
                     headerTitle.innerText = `Ticket #${ticketId}`;
                }

                messages.forEach(message => {
                    appendMessage(message);
                });
                
                // Chat ko neeche scroll karein
                scrollToBottom();
            }

            // --- 6. Helper Function: Ek naya message add karna ---
            function appendMessage(message) {
                // 'message.is_from_user' yeh batata hai ki message user ne bheja hai (right side)
                // ya support agent ne (left side)
                const messageClass = message.is_from_user ? 'chat-bubble sent' : 'chat-bubble received';
                
                const messageHtml = `
                    <div class="${messageClass}">
                        <p>${message.message}</p>
                    </div>
                `;
                chatContainer.innerHTML += messageHtml;
            }

            // --- 7. Helper Function: Chat ko neeche scroll karna ---
            function scrollToBottom() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // --- 8. Form Submission: Naya Message Bhejna ---
            async function handleMessageSubmit(e) {
                e.preventDefault();
                const messageText = messageInput.value.trim();
                if (messageText === '') return; // Khaali message na bhejein

                sendBtn.disabled = true;

                try {
                    const response = await fetch(`/api/support/tickets/${ticketId}/messages/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({ message: messageText })
                    });
                    
                    const newMessage = await response.json();

                    if (!response.ok) {
                        throw new Error(newMessage.detail || 'Failed to send message');
                    }
                    
                    // SUCCESS!
                    messageInput.value = ''; // Input clear karein
                    
                    // "No messages" ko hatayein agar maujood hai
                    const noMsg = chatContainer.querySelector('.status-message');
                    if (noMsg) {
                        noMsg.remove();
                    }
                    
                    // Naye message ko chat mein add karein
                    appendMessage(newMessage);
                    scrollToBottom();

                } catch (error) {
                    console.error('Message send karne mein error:', error);
                    alert('Error sending message. Please try again.');
                } finally {
                    sendBtn.disabled = false;
                }
            }

            // Helper function (agar token invalid ho)
            function handleLogout() {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                checkAuth(); // Redirect karega
            }

            // --- 9. Event Listeners ---
            messageForm.addEventListener('submit', handleMessageSubmit);

            // --- 10. Page Load Par Shuru Karein ---
            if (checkAuth()) {
                ticketId = getTicketId();
                if (ticketId) {
                    fetchMessages(ticketId);
                }
            }

        });
    </script>

</body>
</html>