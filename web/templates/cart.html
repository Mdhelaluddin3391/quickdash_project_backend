{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}"> <link rel="stylesheet" href="{% static 'css/cart_style.css' %}">
    
    <title>QuickDash - Your Cart</title>

    <style>
        /* Loading/Error indicator ke liye */
        .status-message {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="{% url 'web:index' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="header-title">My Cart</h1>
        <div class="header-placeholder"></div>
    </header>

    <main id="main-content-container">

        <div class="status-message" id="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i> Loading your cart...
        </div>

        <div class="cart-items-container" id="cart-items-container">
            </div>

        <div class="bill-details-container" id="bill-details-container">
            </div>

    </main>

    <div class="fixed-checkout-bar" id="checkout-bar" style="display: none;">
        <div class="price-details">
            <span class="total-text">Total</span>
            <span class="total-price" id="bar-total-price">₹0</span>
        </div>
        <a href="{% url 'web:checkout' %}" class="checkout-btn">
            Proceed to Checkout
        </a>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. Zaroori Elements ---
            const mainContainer = document.getElementById('main-content-container');
            const itemsContainer = document.getElementById('cart-items-container');
            const billContainer = document.getElementById('bill-details-container');
            const loader = document.getElementById('loading-indicator');
            const checkoutBar = document.getElementById('checkout-bar');
            const barTotalPrice = document.getElementById('bar-total-price');

            let accessToken = '';

            // --- 2. Authentication Check ---
            function checkAuth() {
                accessToken = localStorage.getItem('accessToken');
                if (!accessToken) {
                    // Agar login nahi hai, toh auth page par bhejo
                    window.location.href = "{% url 'web:auth' %}?next={% url 'web:cart' %}";
                    return false;
                }
                return true;
            }

            // --- 3. Main Function: Cart Data Fetch Karna ---
            async function fetchCartData() {
                loader.style.display = 'block'; // Loader dikhayein
                itemsContainer.innerHTML = '';
                billContainer.innerHTML = '';
                checkoutBar.style.display = 'none';

                try {
                    const response = await fetch('/api/cart/', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            // Token expire ho gaya, wapas login par bhejo
                            localStorage.removeItem('accessToken');
                            localStorage.removeItem('refreshToken');
                            checkAuth(); // Redirect karega
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const cartData = await response.json();
                    
                    // Data milne ke baad, render karein
                    renderCart(cartData);

                } catch (error) {
                    console.error("Cart fetch karne mein error:", error);
                    mainContainer.innerHTML = '<p class="status-message">Error loading cart. Please try again.</p>';
                } finally {
                    loader.style.display = 'none'; // Loader chupayein
                }
            }

            // --- 4. Render Function: Data ko HTML mein badalna ---
            function renderCart(cartData) {
                // Agar cart khaali hai
                if (!cartData.items || cartData.items.length === 0) {
                    mainContainer.innerHTML = `
                        <div class="status-message">
                            <h3>Your cart is empty</h3>
                            <p>Looks like you haven't added anything yet.</p>
                            <a href="{% url 'web:index' %}" class="btn-primary">Shop Now</a>
                        </div>`;
                    return;
                }

                // Kadam 4A: Items render karein
                itemsContainer.innerHTML = ''; // Saaf karein
                cartData.items.forEach(item => {
                    const product = item.product;
                    const itemHtml = `
                        <div class="cart-item-card">
                            <div class="cart-item-image">
                                <img src="${product.main_image}" alt="${product.name}">
                            </div>
                            <div class="cart-item-details">
                                <h3 class="item-title">${product.name}</h3>
                                <div class="item-weight">${item.variant_name}</div>
                                <div class="item-price">₹${item.price}</div>
                            </div>
                            <div class="cart-item-controls">
                                <button classs="quantity-btn" 
                                        data-item-id="${item.id}" 
                                        data-action="decrease" 
                                        ${item.quantity <= 1 ? 'disabled' : ''}>
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="quantity-text">${item.quantity}</span>
                                <button classs="quantity-btn" 
                                        data-item-id="${item.id}" 
                                        data-action="increase">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    itemsContainer.innerHTML += itemHtml;
                });

                // Kadam 4B: Bill Details render karein
                const totals = cartData.totals;
                billContainer.innerHTML = `
                    <div class="bill-card">
                        <h3 class="bill-title">Bill Details</h3>
                        <div class="bill-row">
                            <span>Subtotal</span>
                            <span id="subtotal">₹${totals.subtotal}</span>
                        </div>
                        <div class="bill-row">
                            <span>Delivery Fee</span>
                            <span id="delivery-fee">₹${totals.delivery_fee}</span>
                        </div>
                        <div class="bill-row total-row">
                            <span>Grand Total</span>
                            <span id="grand-total">₹${totals.grand_total}</span>
                        </div>
                    </div>
                `;

                // Kadam 4C: Fixed checkout bar ko update aur display karein
                barTotalPrice.innerText = `₹${totals.grand_total}`;
                checkoutBar.style.display = 'flex';
                
                // Kadam 4D: Naye bane buttons par listeners lagayein
                attachButtonListeners();
            }

            // --- 5. Event Listeners: Buttons ko functional banana ---
            function attachButtonListeners() {
                itemsContainer.querySelectorAll('.quantity-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const target = e.currentTarget;
                        const itemId = target.dataset.itemId;
                        const action = target.dataset.action;
                        
                        // Current quantity nikalna
                        let quantity = parseInt(target.parentElement.querySelector('.quantity-text').innerText);
                        
                        if (action === 'increase') {
                            updateQuantity(itemId, quantity + 1);
                        } else if (action === 'decrease') {
                            if (quantity > 1) {
                                updateQuantity(itemId, quantity - 1);
                            } else {
                                // Agar quantity 1 hai aur minus dabate hain, toh remove karein
                                removeItem(itemId);
                            }
                        }
                    });
                });
            }

            // --- 6. Helper Function: Quantity Update (API Call) ---
            async function updateQuantity(itemId, newQuantity) {
                // Disable buttons temporarily
                mainContainer.style.opacity = '0.5';

                try {
                    const response = await fetch(`/api/cart/item/${itemId}/update/`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}', // POST/PUT ke liye zaroori
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({ quantity: newQuantity })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to update quantity');
                    }
                    
                    // Update safal hone ke baad, poora cart refresh karein
                    await fetchCartData();

                } catch (error) {
                    console.error('Update error:', error);
                    alert('Could not update cart. Please try again.');
                } finally {
                    mainContainer.style.opacity = '1';
                }
            }

            // --- 7. Helper Function: Remove Item (API Call) ---
            async function removeItem(itemId) {
                mainContainer.style.opacity = '0.5';
                
                try {
                    const response = await fetch(`/api/cart/item/${itemId}/remove/`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}', // DELETE ke liye zaroori
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to remove item');
                    }

                    // Remove safal hone ke baad, poora cart refresh karein
                    await fetchCartData();

                } catch (error) {
                    console.error('Remove error:', error);
                    alert('Could not remove item. Please try again.');
                } finally {
                    mainContainer.style.opacity = '1';
                }
            }

            // --- 8. Page Load Par Shuru Karein ---
            if (checkAuth()) {
                fetchCartData();
            }

        });
    </script>

</body>
</html>