{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/checkout_style.css' %}">
    
    <title>QuickDash - Checkout</title>

    <style>
        .status-message {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--text-muted);
        }
        .error-message {
            color: #ff4d4d;
            background-color: #ffdada;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="{% url 'web:cart' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="header-title">Checkout</h1>
        <div class="header-placeholder"></div>
    </header>

    <main id="main-content-container">

        <div class="status-message" id="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i> Loading checkout details...
        </div>

        <form id="checkout-form" style="display: none;">

            <div id="error-message-container"></div>

            <section class="checkout-section">
                <h2 class="section-title">Delivery Address</h2>
                <div class="address-list" id="address-list-container">
                    <p>Loading addresses...</p>
                </div>
                <a href="#" class="add-new-address-btn">+ Add New Address</a>
            </section>

            <section class="checkout-section">
                <h2 class="section-title">Delivery Time</h2>
                <div class="option-card active">
                    <i class="fas fa-bolt"></i>
                    <div class="option-details">
                        <h3>Instant Delivery</h3>
                        <p>Delivered in 10-20 minutes</p>
                    </div>
                </div>
            </section>

            <section class="checkout-section">
                <h2 class="section-title">Payment Method</h2>
                <div class="option-card active" id="payment-cod">
                    <i class="fas fa-wallet"></i>
                    <div class="option-details">
                        <h3>Cash on Delivery</h3>
                        <p>Pay when your order arrives</p>
                    </div>
                </div>
            </section>

            <section class="checkout-section">
                <h2 class="section-title">Bill Summary</h2>
                <div class="bill-card" id="bill-summary-container">
                    <p>Loading bill...</p>
                </div>
            </section>

            <div class="fixed-checkout-bar">
                <div class="price-details">
                    <span class="total-text">Total</span>
                    <span class="total-price" id="bar-total-price">...</span>
                </div>
                <button type="submit" class="checkout-btn" id="place-order-btn">
                    Place Order
                </button>
            </div>
        </form>

    </main>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. Zaroori Elements ---
            const mainContainer = document.getElementById('main-content-container');
            const loader = document.getElementById('loading-indicator');
            const checkoutForm = document.getElementById('checkout-form');
            const placeOrderBtn = document.getElementById('place-order-btn');
            
            const addressContainer = document.getElementById('address-list-container');
            const billContainer = document.getElementById('bill-summary-container');
            const barTotalPrice = document.getElementById('bar-total-price');
            const errorContainer = document.getElementById('error-message-container');

            let accessToken = '';

            // --- 2. Helper Functions (Auth, CSRF) ---
            function getAuthToken() {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    window.location.href = `{% url 'web:auth' %}?next={% url 'web:checkout' %}`;
                    return null;
                }
                return token;
            }

            function getCsrfToken() {
                return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            }
            
            // NAYA: Token Refresh Logic (cart.html se copy kiya)
            async function refreshToken() {
                const refresh = localStorage.getItem('refreshToken');
                if (!refresh) return false;
                try {
                    const response = await fetch('/api/token/refresh/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refresh: refresh })
                    });
                    if (!response.ok) return false;
                    const data = await response.json();
                    localStorage.setItem('accessToken', data.access);
                    accessToken = data.access;
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            // NAYA: API Fetcher (401 retry ke saath)
            async function fetchAuthenticated(url, options = {}, isRetry = false) {
                options.headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`,
                    ...options.headers
                };

                const response = await fetch(url, options);

                if (response.status === 401 && !isRetry) {
                    const refreshed = await refreshToken();
                    if (refreshed) {
                        return fetchAuthenticated(url, options, true); // Retry
                    } else {
                        getAuthToken(); // Redirect to login
                        return null; // Stop execution
                    }
                }
                return response;
            }

            // --- 3. Main Function: Page Load Data ---
            async function loadCheckoutData() {
                try {
                    // Ek saath dono API call karein
                    const [cartResponse, profileResponse] = await Promise.all([
                        fetchAuthenticated('/api/cart/'),
                        fetchAuthenticated('/api/accounts/profile/')
                    ]);

                    if (!cartResponse || !profileResponse) return; // Auth fail hua

                    if (!cartResponse.ok || !profileResponse.ok) {
                        throw new Error('Could not load details. Please go back.');
                    }
                    
                    const cartData = await cartResponse.json();
                    const profileData = await profileResponse.json();
                    
                    // Cart check: Agar cart khaali hai toh wapas bhej do
                    if (!cartData.items || cartData.items.length === 0) {
                        mainContainer.innerHTML = `<p class="status-message">Your cart is empty.<br/><a href="{% url 'web:index' %}">Go shopping</a></p>`;
                        return;
                    }
                    
                    renderBillSummary(cartData.totals);
                    renderAddresses(profileData.addresses);
                    
                    loader.style.display = 'none';
                    checkoutForm.style.display = 'block';

                } catch (error) {
                    console.error("Checkout data load karne mein error:", error);
                    mainContainer.innerHTML = `<p class="status-message">${error.message}</p>`;
                }
            }

            // --- 4. Render Functions ---
            function renderBillSummary(totals) {
                billContainer.innerHTML = `
                    <div class="bill-row">
                        <span>Subtotal</span>
                        <span>₹${totals.subtotal}</span>
                    </div>
                    <div class="bill-row">
                        <span>Delivery Fee</span>
                        <span>₹${totals.delivery_fee}</span>
                    </div>
                    <div class="bill-row total-row">
                        <span>Grand Total</span>
                        <span>₹${totals.grand_total}</span>
                    </div>
                `;
                barTotalPrice.innerText = `₹${totals.grand_total}`;
            }

            function renderAddresses(addresses) {
                addressContainer.innerHTML = '';
                if (!addresses || addresses.length === 0) {
                    addressContainer.innerHTML = '<p>No saved addresses. Please add one.</p>';
                    return;
                }

                addresses.forEach((address, index) => {
                    const isChecked = (address.is_default || index === 0) ? 'checked' : '';
                    
                    const addressHtml = `
                        <div class="address-card">
                            <input type="radio" name="address" id="addr-${address.id}" value="${address.id}" ${isChecked}>
                            <label for="addr-${address.id}">
                                <i class="fas ${address.address_type === 'HOME' ? 'fa-home' : 'fa-briefcase'}"></i>
                                <div class="address-details">
                                    <h3>${address.address_type}</h3>
                                    <p>${address.full_address}</p>
                                    <p>${address.landmark || ''}</p>
                                </div>
                            </label>
                        </div>
                    `;
                    addressContainer.innerHTML += addressHtml;
                });
            }

            // --- 5. Form Submission: Order Place Karna ---
            async function handlePlaceOrder(e) {
                e.preventDefault();
                errorContainer.innerHTML = '';
                
                placeOrderBtn.disabled = true;
                placeOrderBtn.innerText = 'Placing Order...';

                let selectedAddressId;
                try {
                    selectedAddressId = document.querySelector('input[name="address"]:checked').value;
                } catch (err) {
                    errorContainer.innerHTML = '<div class="error-message">Please select a delivery address.</div>';
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.innerText = 'Place Order';
                    return;
                }
                
                const paymentMethod = 'COD'; // Hardcoded

                try {
                    const response = await fetchAuthenticated('/api/orders/checkout/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': getCsrfToken() },
                        body: JSON.stringify({
                            delivery_address_id: parseInt(selectedAddressId),
                            payment_method: paymentMethod
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) { // 400 Bad Request (e.g., cart empty, out of stock)
                        throw new Error(result.detail || 'Could not place order.');
                    }
                    
                    // SUCCESS!
                    // NAYA: Order ID ko success page par pass karein
                    const orderId = result.id || '';
                    window.location.href = `{% url 'web:order-success' %}?order_id=${orderId}`;

                } catch (error) {
                    console.error('Order place karne mein error:', error);
                    errorContainer.innerHTML = `<div class="error-message">${error.message}</div>`;
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.innerText = 'Place Order';
                }
            }

            // --- 6. Event Listeners ---
            checkoutForm.addEventListener('submit', handlePlaceOrder);

            // --- 7. Page Load Par Shuru Karein ---
            accessToken = getAuthToken();
            if (accessToken) {
                loadCheckoutData();
            }
        });
    </script>

</body>
</html>