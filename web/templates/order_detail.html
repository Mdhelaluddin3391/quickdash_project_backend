{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/order_detail_style.css' %}">
    
    <title>QuickDash - Order Details</title>
    <style>
        .status-message {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="{% url 'web:profile' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="header-title" id="order-title">Order Details</h1>
        <div class="header-placeholder"></div>
    </header>

    <main id="main-content-container">
        
        <div class="status-message" id="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i> Loading order details...
        </div>

        <div id="order-content" style="display: none;">
            <section class="order-status-section">
                <div class="status-header">
                    <h2 id="order-id">Order #...</h2>
                    <span class="status-badge" id="order-status">...</span>
                </div>
                <p id="order-date">Placed on ...</p>
            </section>

            <section class="order-summary-section">
                <h3>Order Summary</h3>
                <div class="item-list" id="item-list-container">
                    </div>
            </section>

            <section class="order-details-section">
                <h3>Bill Details</h3>
                <div class="bill-card" id="bill-summary-container">
                    </div>
            </section>

            <section class="order-details-section">
                <h3>Delivery Address</h3>
                <div class="address-card" id="address-container">
                    </div>
            </section>
        </div>

    </main>

    <script>
        // NAYA: Poora JavaScript is page ko dynamic banane ke liye
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. Zaroori Elements ---
            const mainContainer = document.getElementById('main-content-container');
            const loader = document.getElementById('loading-indicator');
            const orderContent = document.getElementById('order-content');
            const orderTitle = document.getElementById('order-title');

            // Sections
            const orderIdElement = document.getElementById('order-id');
            const orderStatusElement = document.getElementById('order-status');
            const orderDateElement = document.getElementById('order-date');
            const itemsContainer = document.getElementById('item-list-container');
            const billContainer = document.getElementById('bill-summary-container');
            const addressContainer = document.getElementById('address-container');

            let accessToken = '';
            let orderPk = '';

            // --- 2. URL se Order PK nikalna ---
            try {
                // e.g., /order/123/
                const pathParts = window.location.pathname.split('/');
                orderPk = pathParts[pathParts.length - 2];
            } catch (e) {
                loader.innerText = "Error: Invalid order URL.";
                return;
            }
            
            // --- 3. Helper Functions (Auth, CSRF, Refresh) ---
            // (Ye functions 'cart.html' se copy kiye gaye hain)
            function getAuthToken() {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    window.location.href = `{% url 'web:auth' %}?next=${window.location.pathname}`;
                    return null;
                }
                return token;
            }

            async function refreshToken() {
                const refresh = localStorage.getItem('refreshToken');
                if (!refresh) return false;
                try {
                    const response = await fetch('/api/token/refresh/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refresh: refresh })
                    });
                    if (!response.ok) return false;
                    const data = await response.json();
                    localStorage.setItem('accessToken', data.access);
                    accessToken = data.access;
                    return true;
                } catch (e) {
                    return false;
                }
            }

            async function fetchAuthenticated(url, options = {}, isRetry = false) {
                options.headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`,
                    ...options.headers
                };
                const response = await fetch(url, options);
                if (response.status === 401 && !isRetry) {
                    const refreshed = await refreshToken();
                    if (refreshed) return fetchAuthenticated(url, options, true);
                    else {
                        getAuthToken();
                        return null;
                    }
                }
                return response;
            }

            // --- 4. Main Function: Order Data Fetch Karna ---
            async function fetchOrderDetails() {
                try {
                    const response = await fetchAuthenticated(`/api/orders/${orderPk}/`);
                    
                    if (!response) return; // Auth fail
                    if (!response.ok) {
                        throw new Error('Order not found or not accessible.');
                    }
                    
                    const orderData = await response.json();
                    renderOrder(orderData);
                    
                    loader.style.display = 'none';
                    orderContent.style.display = 'block';

                } catch (error) {
                    console.error("Order fetch error:", error);
                    loader.innerText = error.message;
                }
            }

            // --- 5. Render Function ---
            function renderOrder(order) {
                // Header
                orderTitle.innerText = `Order #${order.id}`;
                orderIdElement.innerText = `Order #${order.id}`;
                orderStatusElement.innerText = order.status;
                orderStatusElement.className = `status-badge status-${order.status.toLowerCase()}`;
                
                const orderDate = new Date(order.created_at).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' });
                orderDateElement.innerText = `Placed on ${orderDate}`;

                // Items
                itemsContainer.innerHTML = '';
                order.items.forEach(item => {
                    const itemHtml = `
                        <div class="order-item-compact">
                            <span class="item-quantity">${item.quantity} x</span>
                            <div class="item-details">
                                <h4>${item.inventory.product.name}</h4>
                                <p>${item.inventory.variant_name}</p>
                            </div>
                            <span class="item-price">₹${item.price}</span>
                        </div>
                    `;
                    itemsContainer.innerHTML += itemHtml;
                });

                // Bill
                billContainer.innerHTML = `
                    <div class="bill-row">
                        <span>Subtotal</span>
                        <span>₹${order.subtotal}</span>
                    </div>
                    <div class="bill-row">
                        <span>Delivery Fee</span>
                        <span>₹${order.delivery_fee}</span>
                    </div>
                    <div class="bill-row total-row">
                        <span>Grand Total</span>
                        <span>₹${order.total_amount}</span>
                    </div>
                `;
                
                // Address
                const addr = order.delivery_address;
                addressContainer.innerHTML = `
                    <h4>${addr.address_type}</h4>
                    <p>${addr.full_address}</p>
                    <p>${addr.landmark || ''}</p>
                    <p>${addr.city}, ${addr.pincode}</p>
                `;
            }

            // --- 6. Page Load Par Shuru Karein ---
            accessToken = getAuthToken();
            if (accessToken) {
                fetchOrderDetails();
            }
        });
    </script>

</body>
</html>