{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/category_detail.css' %}">
    
    <title>QuickDash - Category</title>
    <style>
        .status-message {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="{% url 'web:category' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="header-title" id="category-name-title">Loading...</h1>
        <div class="header-placeholder"></div>
    </header>

    <main>
        <div class="category-header" id="category-header-banner" style="display: none;">
            <h2 id="category-name-banner"></h2>
            <p id="category-desc"></p>
        </div>

        <section class="product-list-section">
            <div class="product-grid" id="product-grid-container">
                <div class.status-message" id="status-message">
                    <i class="fas fa-spinner fa-spin"></i> Loading products...
                </div>
            </div>
        </section>
    </main>

    <script>
        // NAYA: Poora JavaScript is page ko dynamic banane ke liye
        document.addEventListener('DOMContentLoaded', () => {

            const productContainer = document.getElementById('product-grid-container');
            const statusMessage = document.getElementById('status-message');
            const titleElement = document.getElementById('category-name-title');
            const headerBanner = document.getElementById('category-header-banner');
            const bannerName = document.getElementById('category-name-banner');
            const bannerDesc = document.getElementById('category-desc');

            let categorySlug = '';

            // 1. URL se Category Slug nikalna
            try {
                // e.g., /category/dairy-breakfast/
                const pathParts = window.location.pathname.split('/');
                categorySlug = pathParts[pathParts.length - 2]; // 'dairy-breakfast'
            } catch (e) {
                console.error("Slug nahi mil saka:", e);
                statusMessage.innerText = "Error: Invalid category URL.";
                return;
            }

            if (!categorySlug) {
                statusMessage.innerText = "Error: Category not found.";
                return;
            }

            // 2. Category Details fetch karna (Naam aur Description ke liye)
            async function fetchCategoryDetails() {
                try {
                    const response = await fetch(`/api/store/categories/${categorySlug}/`);
                    if (!response.ok) throw new Error('Category not found');
                    const data = await response.json();
                    
                    // Page par category ka naam update karein
                    titleElement.innerText = data.name;
                    bannerName.innerText = data.name;
                    bannerDesc.innerText = data.description || `Best deals on ${data.name}`;
                    headerBanner.style.display = 'block';

                } catch (error) {
                    console.error("Category details fetch error:", error);
                    titleElement.innerText = "Category";
                }
            }

            // 3. Products fetch karna (Category Slug ke basis par)
            async function fetchCategoryProducts() {
                try {
                    // Location data (latitude/longitude) zaroori hai
                    const lat = localStorage.getItem("userLatitude");
                    const lon = localStorage.getItem("userLongitude");

                    if (!lat || !lon) {
                        // Agar location nahi hai, toh location denied page par bhejo
                        window.location.href = "{% url 'web:location-denied' %}";
                        return;
                    }

                    // NAYA: API call category_slug aur location ke saath
                    const response = await fetch(`/api/inventory/products/?category_slug=${categorySlug}&lat=${lat}&lon=${lon}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const products = await response.json();
                    renderProducts(products);

                } catch (error) {
                    console.error("Products fetch karne mein error:", error);
                    statusMessage.innerText = "Products load nahi ho sake. Please try again.";
                }
            }

            // 4. Products ko HTML mein render karna
            function renderProducts(products) {
                productContainer.innerHTML = ''; // Loader hatayein

                if (!products || products.length === 0) {
                    productContainer.innerHTML = `<p class='status-message'>No products found in this category.</p>`;
                    return;
                }

                products.forEach(item => {
                    const product = item.product; 
                    const variantName = item.variant_name || '';
                    const price = item.price.price;
                    const originalPrice = item.price.original_price;
                    const discount = (originalPrice && parseFloat(price) < parseFloat(originalPrice));
                    const isOutOfStock = item.is_out_of_stock;

                    let priceHtml = `<div class="price">₹${price}</div>`;
                    if (discount) {
                        priceHtml = `<div class="price"><span class="original-price">₹${originalPrice}</span> ₹${price}</div>`;
                    }

                    let buttonHtml = `<button class="add-to-cart" data-variant-id="${item.id}"><i class="fas fa-plus"></i></button>`;
                    if (isOutOfStock) {
                        buttonHtml = `<span class="out-of-stock-btn">Out of Stock</span>`;
                    }

                    const productHtml = `
                        <div class="product-card">
                            <a href="/product/${product.id}/">
                                <div class="product-image">
                                    ${discount ? '<div class="discount-badge">OFF</div>' : ''}
                                    <img src="${product.main_image}" alt="${product.name}">
                                </div>
                            </a>
                            <div class="product-info">
                                <h3 class="product-title">${product.name}</h3>
                                <div class="product-weight">${variantName}</div>
                                <div class="product-price">
                                    ${priceHtml}
                                    ${buttonHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    productContainer.innerHTML += productHtml;
                });
                // NAYA: Cart button listeners
                attachCartButtonListeners();
            }

            // 5. NAYA: Cart Button Logic
            function attachCartButtonListeners() {
                // (Abhi ke liye, yeh function 'cart.html' se alag hai, simple rakha hai)
                const allAddButtons = document.querySelectorAll('.add-to-cart');
                allAddButtons.forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        const variantId = event.currentTarget.dataset.variantId;
                        console.log(`Adding variant ${variantId} to cart...`);
                        
                        // TODO: Yahan 'cart.html' jaisa poora API logic add karna hoga
                        // (Auth check, POST to /api/cart/add/, token refresh)
                        
                        alert('Adding to cart (functionality pending)');
                    });
                });
            }

            // 6. Page load par dono functions call karein
            fetchCategoryDetails();
            fetchCategoryProducts();
        });
    </script>

</body>
</html>