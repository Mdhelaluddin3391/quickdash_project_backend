{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}"> 
    <link rel="stylesheet" href="{% static 'css/category_detail.css' %}">
    
    <title>QuickDash</title>

    <style>
        /* Loading indicator ke liye */
        .loader {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="{% url 'web:category' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="header-title" id="category-name-title">Loading...</h1>
        <div class="header-placeholder"></div>
    </header>

    <main>
        <section class="product-list-section">
            <div class="product-grid" id="product-grid-container">
                <div class="loader" id="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i> Loading products...
                </div>

                </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const productContainer = document.getElementById('product-grid-container');
            const loader = document.getElementById('loading-indicator');
            const titleElement = document.getElementById('category-name-title');

            // 1. URL se Category Slug (e.g., "fruits-veg") nikalna
            let categorySlug = '';
            try {
                // URL path hoga "/category/fruits-veg/"
                // Hum split karke 'fruits-veg' nikalenge
                const pathParts = window.location.pathname.split('/');
                categorySlug = pathParts[2]; // [0]="", [1]="category", [2]="fruits-veg"
            } catch (e) {
                console.error("Slug nahi mil saka:", e);
                loader.innerText = "Error: Invalid category URL.";
                return;
            }

            if (!categorySlug) {
                loader.innerText = "Error: Category not found.";
                return;
            }

            // 2. Products fetch karne ka function
            async function fetchCategoryProducts(slug) {
                try {
                    // Hum 'inventory' app ke product list endpoint ka istemal karenge
                    // aur use category slug se filter karenge.
                    // Yeh API aapke 'inventory/urls.py' aur 'inventory/views.py' se aata hai.
                    const response = await fetch(`/api/inventory/products/?category__slug=${slug}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const products = await response.json();
                    
                    // Data milne ke baad, render function ko call karein
                    renderProducts(products);

                } catch (error) {
                    console.error("Products fetch karne mein error:", error);
                    loader.innerText = "Products load nahi ho sake. Please try again.";
                }
            }

            // 3. Products ko HTML mein render karne ka function
            function renderProducts(products) {
                productContainer.innerHTML = ''; // Loader ko hatayein

                if (!products || products.length === 0) {
                    productContainer.innerHTML = "<p class='loader'>No products found in this category.</p>";
                    // Title ko bhi update karein (slug se)
                    titleElement.innerText = categorySlug.replace(/-/g, ' '); // 'fruits-veg' -> 'fruits veg'
                    return;
                }

                // Title ko pehle product ki category se set karein (behtar tareeka)
                // Assumption: Sabhi products ki category same hogi
                titleElement.innerText = products[0].product.category.name;
                document.title = `QuickDash - ${products[0].product.category.name}`;

                // Loop karke products render karein (yeh code index.html jaisa hai)
                products.forEach(item => {
                    const product = item.product; 
                    const variantName = item.variant_name || '';
                    const price = item.price.price;
                    const originalPrice = item.price.original_price;
                    const discount = (originalPrice && parseFloat(price) < parseFloat(originalPrice));
                    const isOutOfStock = item.is_out_of_stock;

                    let priceHtml = `<div class="price">₹${price}</div>`;
                    if (discount) {
                        priceHtml = `
                            <div class="price">
                                <span class="original-price">₹${originalPrice}</span> ₹${price}
                            </div>
                        `;
                    }

                    let buttonHtml = `<button class="add-to-cart" data-variant-id="${item.id}"><i class="fas fa-plus"></i></button>`;
                    if (isOutOfStock) {
                        buttonHtml = `<span class="out-of-stock-btn">Out of Stock</span>`;
                    }

                    const productHtml = `
                        <div class="product-card">
                            <a href="/product/${product.id}/">
                                <div class="product-image">
                                    ${discount ? '<div class="discount-badge">OFF</div>' : ''}
                                    <img src="${product.main_image}" alt="${product.name}">
                                </div>
                            </a>
                            <div class="product-info">
                                <h3 class="product-title">${product.name}</h3>
                                <div class="product-weight">${variantName}</div>
                                <div class="product-price">
                                    ${priceHtml}
                                    ${buttonHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    productContainer.innerHTML += productHtml;
                });

                // Naye bane 'add-to-cart' buttons par listener lagayein
                attachCartButtonListeners();
            }

            // 4. Cart buttons par logic (index.html se copy kiya gaya)
            function attachCartButtonListeners() {
                const allAddButtons = document.querySelectorAll('.add-to-cart');
                const cartCountElement = document.querySelector('.cart-count'); // Yeh page par nahi hai

                allAddButtons.forEach(button => {
                    if (button.dataset.listenerAttached) return;

                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        const variantId = event.currentTarget.dataset.variantId;
                        console.log(`Adding variant ${variantId} to cart...`);
                        
                        // Yahan Cart API call aani chahiye
                        // Abhi ke liye, hum cart icon update nahi kar rahe hain kyunki woh is page par nahi hai
                        
                        // Sirf button ka state badal dete hain (example)
                        event.currentTarget.innerHTML = '<i class="fas fa-check"></i>';
                        event.currentTarget.disabled = true;
                    });
                    
                    button.dataset.listenerAttached = 'true';
                });
            }

            // 5. Page load par main function ko call karein
            fetchCategoryProducts(categorySlug);
        });
    </script>

</body>
</html>