{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/search_results_style.css' %}">
    
    <title>QuickDash - Search Results</title>

    <style>
        /* Loading/Error indicator ke liye */
        .status-message {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="{% url 'web:index' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <form class="search-bar-header" method="GET" action="{% url 'web:search' %}">
            <i class="fas fa-search"></i>
            <input type="text" name="q" placeholder="Search for items..." id="search-input">
        </form>
    </header>

    <main>
        <section class="product-list-section">
            <h2 class="search-results-title" id="results-title">
                Loading results...
            </h2>
            
            <div class="product-grid" id="product-grid-container">
                <div class="status-message" id="status-message">
                    <i class="fas fa-spinner fa-spin"></i> Searching...
                </div>

                </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const productContainer = document.getElementById('product-grid-container');
            const statusMessage = document.getElementById('status-message');
            const titleElement = document.getElementById('results-title');
            const searchInputElement = document.getElementById('search-input');

            // 1. URL se Search Query (e.g., "milk") nikalna
            let searchQuery = '';
            try {
                // URLSearchParams ka istemal karke URL se 'q' parameter nikalenge
                const urlParams = new URLSearchParams(window.location.search);
                searchQuery = urlParams.get('q');
            } catch (e) {
                console.error("Query nahi mil saki:", e);
                statusMessage.innerText = "Error: Invalid search URL.";
                return;
            }

            if (!searchQuery) {
                titleElement.innerText = "Search";
                statusMessage.innerText = "Please type something in the search bar to find products.";
                return;
            }

            // Search query ko input box mein bhi dikhayein
            searchInputElement.value = searchQuery;
            titleElement.innerText = `Results for "${searchQuery}"`;

            // 2. Products fetch karne ka function
            async function fetchSearchProducts(query) {
                try {
                    // Hum 'inventory' app ke product list endpoint ka istemal karenge
                    // aur 'search' parameter ka istemal karenge.
                    // Yeh aapke 'inventory/views.py' ke 'search_fields' se match karega
                    const response = await fetch(`/api/inventory/products/?search=${encodeURIComponent(query)}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const products = await response.json();
                    
                    // Data milne ke baad, render function ko call karein
                    renderProducts(products);

                } catch (error) {
                    console.error("Products fetch karne mein error:", error);
                    statusMessage.innerText = "Products load nahi ho sake. Please try again.";
                }
            }

            // 3. Products ko HTML mein render karne ka function
            function renderProducts(products) {
                productContainer.innerHTML = ''; // Loader/Status ko hatayein

                if (!products || products.length === 0) {
                    productContainer.innerHTML = `<p class='status-message'>No products found matching "${searchQuery}".</p>`;
                    return;
                }

                // Loop karke products render karein (yeh code category_detail.html jaisa hai)
                products.forEach(item => {
                    const product = item.product; 
                    const variantName = item.variant_name || '';
                    const price = item.price.price;
                    const originalPrice = item.price.original_price;
                    const discount = (originalPrice && parseFloat(price) < parseFloat(originalPrice));
                    const isOutOfStock = item.is_out_of_stock;

                    let priceHtml = `<div class="price">₹${price}</div>`;
                    if (discount) {
                        priceHtml = `
                            <div class="price">
                                <span class="original-price">₹${originalPrice}</span> ₹${price}
                            </div>
                        `;
                    }

                    let buttonHtml = `<button class="add-to-cart" data-variant-id="${item.id}"><i class="fas fa-plus"></i></button>`;
                    if (isOutOfStock) {
                        buttonHtml = `<span class="out-of-stock-btn">Out of Stock</span>`;
                    }

                    const productHtml = `
                        <div class="product-card">
                            <a href="/product/${product.id}/">
                                <div class="product-image">
                                    ${discount ? '<div class="discount-badge">OFF</div>' : ''}
                                    <img src="${product.main_image}" alt="${product.name}">
                                </div>
                            </a>
                            <div class="product-info">
                                <h3 class="product-title">${product.name}</h3>
                                <div class="product-weight">${variantName}</div>
                                <div class="product-price">
                                    ${priceHtml}
                                    ${buttonHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    productContainer.innerHTML += productHtml;
                });

                // Naye bane 'add-to-cart' buttons par listener lagayein
                attachCartButtonListeners();
            }

            // 4. Cart buttons par logic
            function attachCartButtonListeners() {
                // (Yeh code pehle jaisa hi hai, abhi ke liye sirf console log karega)
                const allAddButtons = document.querySelectorAll('.add-to-cart');
                allAddButtons.forEach(button => {
                    if (button.dataset.listenerAttached) return;
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        const variantId = event.currentTarget.dataset.variantId;
                        console.log(`Adding variant ${variantId} to cart...`);
                    });
                    button.dataset.listenerAttached = 'true';
                });
            }

            // 5. Page load par main function ko call karein
            fetchSearchProducts(searchQuery);
        });
    </script>

</body>
</html>