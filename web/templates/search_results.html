{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/index_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/search_results_style.css' %}">
    
    <title>QuickDash - Search Results</title>

    <style>
        .status-message {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <header class="simple-header">
        <a href="{% url 'web:index' %}" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <form class="search-bar-header" method="GET" action="{% url 'web:search' %}">
            <i class="fas fa-search"></i>
            <input type="text" name="q" placeholder="Search for items..." id="search-input">
        </form>
    </header>

    <main>
        <section class="product-list-section">
            <h2 class="search-results-title" id="results-title">
                Loading results...
            </h2>
            
            <div class="product-grid" id="product-grid-container">
                <div class="status-message" id="status-message">
                    <i class="fas fa-spinner fa-spin"></i> Searching...
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const productContainer = document.getElementById('product-grid-container');
            const statusMessage = document.getElementById('status-message');
            const titleElement = document.getElementById('results-title');
            const searchInputElement = document.getElementById('search-input');
            
            let accessToken = localStorage.getItem('accessToken');

            // --- 1. URL se Search Query nikalna ---
            let searchQuery = '';
            try {
                const urlParams = new URLSearchParams(window.location.search);
                searchQuery = urlParams.get('q');
            } catch (e) {
                statusMessage.innerText = "Error: Invalid search URL.";
                return;
            }

            if (!searchQuery) {
                titleElement.innerText = "Search";
                statusMessage.innerText = "Please type something to find products.";
                return;
            }

            searchInputElement.value = searchQuery;
            titleElement.innerText = `Results for "${searchQuery}"`;
            
            // --- 2. Helper Functions (Auth, CSRF, Refresh) ---
            // (Ye functions 'index.html' se copy kiye gaye hain)
            function getCsrfToken() {
                return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            }
            async function refreshToken() {
                const refresh = localStorage.getItem('refreshToken');
                if (!refresh) return false;
                try {
                    const response = await fetch('/api/token/refresh/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refresh: refresh })
                    });
                    if (!response.ok) return false;
                    const data = await response.json();
                    localStorage.setItem('accessToken', data.access);
                    accessToken = data.access;
                    return true;
                } catch (e) {
                    return false;
                }
            }


            // --- 3. Products fetch karne ka function ---
            async function fetchSearchProducts(query) {
                try {
                    // Location data (latitude/longitude) zaroori hai
                    const lat = localStorage.getItem("userLatitude");
                    const lon = localStorage.getItem("userLongitude");
                    if (!lat || !lon) {
                        window.location.href = "{% url 'web:location-denied' %}";
                        return;
                    }

                    // NAYA: API call search query aur location ke saath
                    const response = await fetch(`/api/inventory/products/?search=${encodeURIComponent(query)}&lat=${lat}&lon=${lon}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const products = await response.json();
                    renderProducts(products);

                } catch (error) {
                    console.error("Products fetch error:", error);
                    statusMessage.innerText = "Products load nahi ho sake. Please try again.";
                }
            }

            // --- 4. Products ko HTML mein render karna ---
            function renderProducts(products) {
                productContainer.innerHTML = ''; // Loader hatayein

                if (!products || products.length === 0) {
                    productContainer.innerHTML = `<p class='status-message'>No products found matching "${searchQuery}".</p>`;
                    return;
                }

                products.forEach(item => {
                    const product = item.product; 
                    const variantName = item.variant_name || '';
                    const price = item.price.price;
                    const originalPrice = item.price.original_price;
                    const discount = (originalPrice && parseFloat(price) < parseFloat(originalPrice));
                    const isOutOfStock = item.is_out_of_stock;
                    const mainImage = item.image || product.main_image;

                    let priceHtml = `<div class="price">₹${price}</div>`;
                    if (discount) {
                        priceHtml = `<div class="price"><span class="original-price">₹${originalPrice}</span> ₹${price}</div>`;
                    }

                    let buttonHtml = `<button class="add-to-cart" data-variant-id="${item.id}"><i class="fas fa-plus"></i></button>`;
                    if (isOutOfStock) {
                        buttonHtml = `<span class="out-of-stock-btn">Out of Stock</span>`;
                    }

                    const productHtml = `
                        <div class="product-card">
                            <a href="/product/${product.id}/">
                                <div class="product-image">
                                    ${discount ? '<div class="discount-badge">OFF</div>' : ''}
                                    <img src="${mainImage}" alt="${product.name}">
                                </div>
                            </a>
                            <div class="product-info">
                                <h3 class="product-title">${product.name}</h3>
                                <div class="product-weight">${variantName}</div>
                                <div class="product-price">
                                    ${priceHtml}
                                    ${buttonHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    productContainer.innerHTML += productHtml;
                });

                attachCartButtonListeners();
            }

            // --- 5. NAYA: Cart Button Logic (index.html se copy kiya) ---
            function attachCartButtonListeners() {
                document.querySelectorAll('.add-to-cart').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const variantId = e.currentTarget.dataset.variantId;
                        addToCart(variantId, button);
                    });
                });
            }

            async function addToCart(variantId, button, isRetry = false) {
                if (!accessToken) {
                    window.location.href = `{% url 'web:auth' %}?next=${window.location.pathname}${window.location.search}`;
                    return;
                }
                
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    const response = await fetch('/api/cart/add/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify({ inventory_id: variantId, quantity: 1 })
                    });
                    
                    if (response.status === 401 && !isRetry) {
                        const refreshed = await refreshToken();
                        if (refreshed) addToCart(variantId, button, true);
                        else window.location.href = `{% url 'web:auth' %}?next=${window.location.pathname}${window.location.search}`;
                        return;
                    }
                    if (!response.ok) throw new Error('Could not add to cart');
                    
                    button.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-plus"></i>';
                    }, 1000);

                } catch (error) {
                    button.innerHTML = '<i class="fas fa-times"></i>';
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-plus"></i>';
                    }, 1000);
                }
            }

            // --- 6. Page load par main function ko call karein ---
            fetchSearchProducts(searchQuery);
        });
    </script>

</body>
</html>